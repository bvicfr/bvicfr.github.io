<!DOCTYPE html>
<html>
	<head>
		<meta charset='UTF-8'>
		<title>SupremeEnhancingUtensil</title>
		<script
			  src='https://code.jquery.com/jquery-3.3.1.min.js'
			  integrity='sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8='
			  crossorigin='anonymous'></script>
	</head>
	<style type="text/css" media="screen">
		.box {
			-webkit-box-shadow: 5px 5px 15px 5px #000000;
			box-shadow: 5px 5px 15px 5px #000000;
		}
		
		table {
			font-family: arial, sans-serif;
			border-collapse: collapse;
			width: 100%;
		}

		td, th {
			border: 1px solid #dddddd;
			text-align: left;
			padding: 4px;
		}

		tr:nth-child(even) {
			background-color: #dddddd;
		}
		
		input {
			width: 60px
		}
		
		.selectedStrategyButton {
			color: white;
			border-color: rgb(75, 129, 232);
			background-color: rgb(75, 129, 232);
		}
		.unSelectedStrategyButton {
			color: rgb(75, 129, 232);
			border-color: rgb(75, 129, 232);
			transition: all 300ms linear;
		}
		.unSelectedStrategyButton:hover {
			color: white;
			background-color: rgb(95, 150, 260);
		}
	</style>
	<body>
		<h1 style='text-align: center; margin: 5px'>Supreme Enhancing Utensil <small>v0.6</small></h1>
		<h3 style='text-align: center; margin: 5px'><small>The enhancement simulator turning random clicking into data science</small></h3>
		<div>
			<div style='width: 32%; float: left; margin-right: 20px'>
				<div class='box'>
					<div id='myItem'>
						Bonjour
					</div>
					<div>
						<select id="newItemName">
							<option value="Militia">Militia</option>
							<option value="Reblath">Reblath</option>
							<option value="Green Weapon">Green Weapon</option>
							<option value="Green Armor">Green Armor</option>
							<option value="Yellow Weapon">Yellow Weapon</option>
							<option value="Yellow Armor">Yellow Armor</option>
							<option value="Blackstar Weapon">Blackstar Weapon</option>
							<option value="Blackstar Armor">Blackstar Armor</option>
							<option value="Tuvala Weapon">Tuvala Weapon</option>
							<option value="Tuvala Armor">Tuvala Armor</option>
							<option value="GBY Accessory">GBY Accessory</option>
							<option value="Green Ship Part">Green Ship Part</option>
							<option value="Blue Ship Part">Blue Ship Part</option>
						</select>
						<select id="newItemRank">
							<option value="PEN">PEN</option>
							<option value="TET">TET</option>
							<option value="TRI">TRI</option>
							<option value="DUO">DUO</option>
							<option value="PRI">PRI</option>
							<option value="15">15</option>
							<option value="14">14</option>
							<option value="13">13</option>
							<option value="12">12</option>
							<option value="11">11</option>
							<option value="10">10</option>
							<option value="9">9</option>
							<option value="8">8</option>
							<option value="7">7</option>
							<option value="6">6</option>
							<option value="5">5</option>
							<option value="4">4</option>
							<option value="3">3</option>
							<option value="2">2</option>
							<option value="1">1</option>
							<option value="0">0</option>
						</select>
						<button onclick='myItem = createItem($("#newItemName").val(), $("#newItemRank").val()); updateDisplay()'>Buy item</button><br>
						<button onclick='myItem.enhance(); updateDisplay()'>Enhance</button>
						<button onclick='myItem.purify(); updateDisplay()'>Purify</button>
						<button onclick='myItem.sell(); updateDisplay()'>Sell</button>
					</div>
				</div>
				<div class='box'>
					<div id='currentFailstack'>
						Bonjour
					</div>
					<span>
						<input type="text" id="newFS" placeholder="FS value">
						<button onclick='currentFailstack = parseInt($("#newFS").val()); updateDisplay()'>Set new FS</button><br>
						<button onclick='currentFailstack = (currentFailstack<25)? 0 : currentFailstack - 25; updateDisplay()'>-25</button>
						<button onclick='currentFailstack = (currentFailstack<5)? 0 : currentFailstack - 5; updateDisplay()'>-5</button>
						<button onclick='currentFailstack = (currentFailstack<1)? 0 : currentFailstack - 1; updateDisplay()'>-1</button>
						<button onclick='currentFailstack = 0; updateDisplay()'>0</button>
						<button onclick='currentFailstack += 1; updateDisplay()'>+1</button>
						<button onclick='currentFailstack += 5; updateDisplay()'>+5</button>
						<button onclick='currentFailstack += 25; updateDisplay()'>+25</button>
					</span>
				</div>
				
				<div class='box'>
					<h3>
						Use mass processing ! <small id='isRunning' style='display: none'>...running...</small>
					</h3>
					
					Repetitions: <span id=numberOfRepetitions>1</span><br><input type="text" id="numberOfRepetitionsInput" placeholder="Number of repetitions" value="1">
					<button onclick='numberOfRepetitions = parseInt($("#numberOfRepetitionsInput").val());
					$("#numberOfRepetitions").html(String(numberOfRepetitions));
					updateDisplay();'>Set number of repetitions</button>
					<br><br>
						
					<table>
						<tr>
							<td id='failstackModeButton' class='selectedStrategyButton' onclick='
								$("#failstackModeButton").addClass("selectedStrategyButton");
								$("#failstackModeButton").removeClass("unSelectedStrategyButton");
								$("#failstackMode").show();
								
								$("#singleItemModeButton").addClass("unSelectedStrategyButton");
								$("#singleItemModeButton").removeClass("selectedStrategyButton");
								$("#singleItemMode").hide();
							'>Failstack strategy</td>
							<td id='singleItemModeButton' class='unSelectedStrategyButton' onclick='
							$("#failstackModeButton").removeClass("selectedStrategyButton");
								$("#failstackModeButton").removeClass("selectedStrategyButton");
								$("#failstackModeButton").addClass("unSelectedStrategyButton");
								$("#failstackMode").hide();
								
								$("#singleItemModeButton").removeClass("unSelectedStrategyButton");
								$("#singleItemModeButton").addClass("selectedStrategyButton");
								$("#singleItemMode").show();
							'>Single item strategy</td>
						</tr>
					</table>
					<div id='failstackMode'>
						<h3>Part 1: Define the failstack building strategy</h3>
						<button id='autoPurifyButton' onclick='autoPurifyReblath15 = !autoPurifyReblath15; $("#autoPurifyButton").html(autoPurifyReblath15 ? "Auto-purify [Reblath (15)] is ON" : "Auto-purify [Reblath (15)] is OFF")'>Auto-purify [Reblath (15)] is ON</button>
						<table id="sampleStep" style="display:none">
							<tr>
								<td><input type="text" value="0"></td>
								<td>
									<select>
										<option value="Militia">Militia</option>
										<option value="Reblath" selected>Reblath</option>
										<option value="Green Weapon">Green Weapon</option>
										<option value="Green Armor">Green Armor</option>
										<option value="Yellow Weapon">Yellow Weapon</option>
										<option value="Yellow Armor">Yellow Armor</option>
										<option value="Blackstar Weapon">Blackstar Weapon</option>
										<option value="Blackstar Armor">Blackstar Armor</option>
										<option value="Tuvala Weapon">Tuvala Weapon</option>
										<option value="Tuvala Armor">Tuvala Armor</option>
										<option value="GBY Accessory">GBY Accessory</option>
										<option value="Green Ship Part">Green Ship Part</option>
										<option value="Blue Ship Part">Blue Ship Part</option>
									</select>
									<select>
										<option value="TET">TET</option>
										<option value="TRI">TRI</option>
										<option value="DUO">DUO</option>
										<option value="PRI">PRI</option>
										<option value="15">15</option>
										<option value="14" selected>14</option>
										<option value="13">13</option>
										<option value="12">12</option>
										<option value="11">11</option>
										<option value="10">10</option>
										<option value="9">9</option>
										<option value="8">8</option>
										<option value="7">7</option>
										<option value="6">6</option>
										<option value="5">5</option>
										<option value="4">4</option>
										<option value="3">3</option>
										<option value="2">2</option>
										<option value="1">1</option>
										<option value="0">0</option>
									</select>
								</td>
								<td><button onclick='
									let newStartStep = $(this).parent().parent().find("input").val();
									let newName = $(this).parent().parent().find("select").first().val();
									let newRankPen = Item.rankToPen(Math.min(19, Item.rankTo20(
										$(this).parent().parent().find("select").last().val()
									) + 1));
									
									let index = $(this).parent().parent().index("#steps tr");
									
									addStep(newStartStep, newName, newRankPen, index);
								'>+</button>
								<button onclick='
									let newStartStep = $(this).parent().parent().find("input").val();
									let newName = $(this).parent().parent().find("select").first().val();
									let newRankPen = Item.rankToPen(Math.max(0, Item.rankTo20(
										$(this).parent().parent().find("select").last().val()
									) - 1));
									
									let index = $(this).parent().parent().index("#steps tr");
									
									addStep(newStartStep, newName, newRankPen, index-1);
								'>-</button>
								<button onclick='$(this).parent().parent().remove()'>X</button></td>
							</tr>
						</table>
						<table id='steps'>
							<tr><th>Start at FS</th><th>Item</th><th></th></tr>
						</table><br>
						<button onclick='$("#steps").append($("#sampleStep :first-child").html())'>Add step</button><br><br>
						
						Stop condition:<br>
						<select id='stopConditionType' onchange='
							if($("#stopConditionType").val() == "successOnLastStep") {
								$("#stopConditionTargetStack").hide();
							} else {
								$("#stopConditionTargetStack").show();
							}
						'>
							<option value='successOnLastStep'>successOnLastStep</option>
							<option value='reachFailstack' selected>reachFailstack</option>
						</select>
						<input type='text' id='stopConditionTargetStack' value='20'><br><br>
						<button onclick='
							currentFailstack = playerSettings["permanentFailstack"];
							componentsUsed = {};
							itemsProduced = {};
							naderr = [];
							failstacksUsed = {};
							$("#logs").html("");
							
							let stopCondition = {
								type: $("#stopConditionType").val(),
								targetStack: $("#stopConditionTargetStack").val()
							};
							
							
							let arrayOfSteps = $.map($("#steps tr:not(:has(th))"), function(elem) {
								return {
									startStep: $(elem).find("input:first").val(),
									name: $($(elem).find("select")[0]).val(),
									rank: $($(elem).find("select")[1]).val()
								}
							});
							
							if(displayOnOff && numberOfRepetitions > 10) {
								toggleDisplayOnOff();
							}
							
							$("#isRunning").show();
							timeStart = new Date().getTime();
							runRepetition(1, runStrategy, [stopCondition, arrayOfSteps]);
						'>Run the strategy</button>
						
						<hr>
						
						<h3>Part 2: Optimise the strategy</h3>
						
						Find automatically the best failstacks levels to start each step at.<br><br>
						
						Not available yet. 
						
						<hr>
						
						<h3>Part 3: Compute the cost to produce failstacks</h3>
						
						Use the optimised strategy to compute the items and materials involved in building failstacks, for all failstack levels.<br><br>
						
						It is recommanded to first set repetitions to 1000 or even above to get accurate averages. It will take a few minutes to compute.<br><br>
						
						Maximum failstack computed: <input type='text' id='maxComputedFailstack' value='120'><br><br>
						
						<button id='launchFailstackComputation' onclick='
							$("#logs").html("");							
							
							let arrayOfSteps = $.map($("#steps tr:not(:has(th))"), function(elem) {
								return {
									startStep: $(elem).find("input:first").val(),
									name: $($(elem).find("select")[0]).val(),
									rank: $($(elem).find("select")[1]).val()
								}
							});
							
							if(displayOnOff) {
								toggleDisplayOnOff();
							}
							
							$("#isRunning").show();
							failstackComputeTimeStart = new Date().getTime();
							timeStart = new Date().getTime();
							
							myItem = createItem(arrayOfSteps[0].name, arrayOfSteps[0].rank);
							currentFailstack = playerSettings["permanentFailstack"];
							componentsUsed = {};
							itemsProduced = {};
							naderr = [];
							failstacksUsed = {};
							
							runFailstackLevel(playerSettings["permanentFailstack"]+1, Number($("#maxComputedFailstack").val()), 1, arrayOfSteps);
						'>Launch the computation</button>
						
						<hr>
						
						<h3>Examples of strategies</h3>
						
						<p>Classic [Reblath (14)] to build a failstack of +20.</p>
						<button onclick='
							deleteAllStrategies();
							addStep(0, "Reblath", "14");
							setStopConditionType("reachFailstack");
							$("#stopConditionTargetStack").val(20);
						'>Load strategy</button>
						
						<p>Use Reblath then Green Armor to reach a failstack of +100</p>
						<button onclick='
							deleteAllStrategies();
							addStep(0, "Reblath", "14");
							addStep(20, "Green Armor", "PRI");
							addStep(30, "Green Armor", "DUO");
							addStep(50, "Green Armor", "TRI");
							addStep(70, "Green Armor", "TET");
							setStopConditionType("reachFailstack");
							$("#stopConditionTargetStack").val(100);
						'>Load strategy</button>
						
						<p>Make a [Blackstar Weapon (PEN)] ... well, not ingame unfortunately</p>
						<button onclick='
							deleteAllStrategies();
							addStep(0, "Reblath", "14");
							addStep(20, "Green Armor", "PRI");
							addStep(30, "Green Armor", "DUO");
							addStep(50, "Green Armor", "TRI");
							addStep(100, "Yellow Armor", "TET");
							addStep(200, "Blackstar Weapon", "TET");
							setStopConditionType("successOnLastStep");
						'>Load strategy</button>
					</div>
					<div id='singleItemMode' style='display:none'>
						<h3>Part 4: Define the single item enhancing strategy</h3>
						
						Load failstacks when necessary to enhance a single item increasing and decreasing in rank.<br>
						If the failstack goes above the threshold of the next rank, it is stored in the Naderr's band.<br>
						Failstacks in the Naderr's band are kept for following repetitions.<br><br>
						I have no idea whether extra failstacks in the Naderr's band at the end of repetitions should be valued, currently they are worthless but still displayed so you can get an idea of the excess production of failstacks. There is also no way to force using excess failstacks on lower rank items.<br><br>
						For accessories, if you want to start from rank 0, set Start at 15 (I'm too lazy to make an adapted display just for accessories)<br><br>
						
						
						<select id="singleName">
							<option value="Militia">Militia</option>
							<option value="Reblath">Reblath</option>
							<option value="Green Weapon">Green Weapon</option>
							<option value="Green Armor">Green Armor</option>
							<option value="Yellow Weapon" selected>Yellow Weapon</option>
							<option value="Yellow Armor">Yellow Armor</option>
							<option value="Blackstar Weapon">Blackstar Weapon</option>
							<option value="Blackstar Armor">Blackstar Armor</option>
							<option value="Tuvala Weapon">Tuvala Weapon</option>
							<option value="Tuvala Armor">Tuvala Armor</option>
							<option value="GBY Accessory">GBY Accessory</option>
							<option value="Green Ship Part">Green Ship Part</option>
							<option value="Blue Ship Part">Blue Ship Part</option>
						</select>
						
						Start: 
						<select id="singleStart" onchange='
							$("#singleSteps").html("<tr><th>Use at least at a FS of</th><th>at rank</th></tr>");
							for(let i=Item.rankTo20($("#singleStart").val()); i<Item.rankTo20($("#singleGoal").val()); i++) {
								$("#singleSteps").append("<tr><td><input type=\"text\" value=\"0\"></td><td>"+Item.rankToPen(i)+"</td></tr>");
							}
						'>
							<option value="TET">TET</option>
							<option value="TRI">TRI</option>
							<option value="DUO">DUO</option>
							<option value="PRI" selected>PRI</option>
							<option value="15">15</option>
							<option value="14">14</option>
							<option value="13">13</option>
							<option value="12">12</option>
							<option value="11">11</option>
							<option value="10">10</option>
							<option value="9">9</option>
							<option value="8">8</option>
							<option value="7">7</option>
							<option value="6">6</option>
							<option value="5">5</option>
							<option value="4">4</option>
							<option value="3">3</option>
							<option value="2">2</option>
							<option value="1">1</option>
							<option value="0">0</option>
						</select>
						
						Goal: 
						<select id="singleGoal" onchange='
							$("#singleSteps").html("<tr><th>Use at least at a FS of</th><th>at rank</th></tr>");
							for(let i=Item.rankTo20($("#singleStart").val()); i<Item.rankTo20($("#singleGoal").val()); i++) {
								$("#singleSteps").append("<tr><td><input type=\"text\" value=\"0\"></td><td>"+Item.rankToPen(i)+"</td></tr>");
							}
						'>
							<option value="PEN" selected>PEN</option>
							<option value="TET">TET</option>
							<option value="TRI">TRI</option>
							<option value="DUO">DUO</option>
							<option value="PRI">PRI</option>
							<option value="15">15</option>
							<option value="14">14</option>
							<option value="13">13</option>
							<option value="12">12</option>
							<option value="11">11</option>
							<option value="10">10</option>
							<option value="9">9</option>
							<option value="8">8</option>
							<option value="7">7</option>
							<option value="6">6</option>
							<option value="5">5</option>
							<option value="4">4</option>
							<option value="3">3</option>
							<option value="2">2</option>
							<option value="1">1</option>
						</select><br/><br>
						
						<table id='singleSteps'>
							<tr><th>Use at least at a FS of</th><th>at rank</th></tr>
							<tr><td><input type="text" value="30"></td><td>PRI</td></tr>
							<tr><td><input type="text" value="45"></td><td>DUO</td></tr>
							<tr><td><input type="text" value="60"></td><td>TRI</td></tr>
							<tr><td><input type="text" value="100"></td><td>TET</td></tr>
						</table><br>
						
						<button onclick='
							currentFailstack = playerSettings["permanentFailstack"];
							componentsUsed = {};
							itemsProduced = {};
							naderr = [];
							failstacksUsed = {};
							$("#logs").html("");
							
							let singleName =  $("#singleName").val();
							let singleStart =  $("#singleStart").val();
							let singleGoal =  $("#singleGoal").val();
							
							if(getType(singleName) == "accessory") {
								playerSettings["accessoryResetRank"] = Accessory.rankToPen(Accessory.rankTo20(singleStart));
								updateSettings();
							}
							
							let arrayOfSteps = $.map($("#singleSteps input"), function(elem) {return $(elem).val()});
							
							if(displayOnOff && numberOfRepetitions > 10) {
								toggleDisplayOnOff();
							}
							
							$("#isRunning").show();
							timeStart = new Date().getTime();
							runRepetition(1, runSingleItemStrategy, [singleName, singleStart, singleGoal, arrayOfSteps]);
						'>Run the single item strategy</button>
						
						<hr>
						
						<h3>Part 5: Optimise the single item strategy</h3>
						
						Optimise the strategy and then ... at last ... profit.<br><br>
						
						Not available yet.
					</div>
				</div>
			</div>
			<div style='width: 35%; float: left; margin-right: 20px'>
			<!-- -->
				<div class='box'>
					<h3>
							Components used (<span class="typeOfDisplay">average</span>) <button onclick='typeOfDisplay = (typeOfDisplay == "cumulative") ? "average" : "cumulative";
						$(".typeOfDisplay").html(typeOfDisplay);
						updateDisplay();'>Toggle average/cumulative</button>
					</h3>
					<table id='componentsUsed'>
					</table>
					<p>
						<button onclick='componentsUsed = {}; updateDisplay()'>Reset components</button>
					</p>
				</div>
				<div class='box'>
					<h3>
							Items produced (<span class="typeOfDisplay">average</span>)
					</h3>
					<table id='itemsProduced'>
					</table>
					<span>
						<button onclick='itemsProduced = {}; updateDisplay()'>Reset items</button>
					</span>
				</div>
				<div class='box'>
					<h3>
							Naderr's band
					</h3>
					<table id='naderr'>
					</table>
				</div>
				<div class='box'>
					<h3>
							Failstacks used (<span class="typeOfDisplay">average</span>)
					</h3>
					<table id='failstacksUsed'>
					</table>
				</div>
				<div class='box'>
					<h3>
							Component prices <button id="editComponents" onclick='modeEditComponents = true;
								$("#editComponents").hide();
								$("#saveComponents").show();
								updateSettings();
								updateDisplay();
							'>Edit</button><button id="saveComponents" style="display:none" onclick='modeEditComponents = false;
								$("#editComponents").show();
								$("#saveComponents").hide();
								saveComponentPrices();
								updateDisplay();
							'>Save</button>
					</h3>
					<table id='componentPrices'>
					</table>
					<button onclick='computeConcentratedFromMaterials(); updateSettings(); updateDisplay();'>Compute concentrated stones price from materials</button>
				</div>
				<div class='box'>
					<h3>
							Item prices <button id="editItems" onclick='modeEditItems = true;
								$("#editItems").hide();
								$("#saveItems").show();
								updateSettings();
								updateDisplay();
							'>Edit</button><button id="saveItems" style="display:none" onclick='modeEditItems = false;
								$("#editItems").show();
								$("#saveItems").hide();
								saveItemPrices();
								updateDisplay();
							'>Save</button>
					</h3>
					<table id='itemPrices'>
					</table>
				</div>
				<div class='box'>
					<h3>
							Player settings <button id="editPlayerSettings" onclick='modeEditPlayerSettings = true;
								$("#editPlayerSettings").hide();
								$("#savePlayerSettings").show();
								updateSettings();
								updateDisplay();
							'>Edit</button><button id="savePlayerSettings" style="display:none" onclick='modeEditPlayerSettings = false;
								$("#editPlayerSettings").show();
								$("#savePlayerSettings").hide();
								savePlayerSettings();
								updateDisplay();
							'>Save</button>
					</h3>
					<table id='playerSettings'>
					</table>
				</div>
				<div class='box'>
					<h3>
							Failstack costs
					</h3>
					<table id='failstackCosts'>
					</table>
				</div>
			</div>
			<div style='width: 28%; float: left;'>
				<div class='box'>
					<p><button onclick='$("#logs").html("");'>Clear</button>
					<button id='displayOnOff' onclick='toggleDisplayOnOff()'>All steps displayed (slow)</button></p>
					<div id=logs>
						<p>Logs</p>
					</div>
					<button onclick='$("#logs").html($("#changeLogs").html());'>Show change logs</button></p>
				</div>
			</div>
		</div>
		
		<script>
			function objAdd(obj, key, increment) {
				if( !(key in obj) ) {
					obj[key] = increment;
				} else {
					obj[key] += increment;
				}
			}
			
			function runRepetition(repetition, func, params) {
				$("#isRunning").html('...'+(repetition-1)+' / '+numberOfRepetitions+'...');
				for(let i=repetition; i<repetition+50; i++) {
					
					if(i > numberOfRepetitions) {
						let timeEnd = new Date().getTime();
						$("#isRunning").hide();
						$("#logs").prepend("<p>... Duration: "+String((timeEnd-timeStart)*1.0/1000)+"s Repetitions: "+String(numberOfRepetitions)+"</p>");
						return;
					}
				
					currentFailstack = playerSettings['permanentFailstack'];
					func.apply(null, params);
					
					if(displayOnOff) $("#logs").prepend("<p>... Repetition "+i+" / "+numberOfRepetitions+" done</p>");
					updateDisplay();
				}
				
				setTimeout(function() {
					runRepetition(repetition+50, func, params);
				},10);
			}
			
			function runFailstackLevel(level, maxLevel, repetition, arrayOfSteps) {
				$("#isRunning").html('...fs'+level+' / '+maxLevel+'......'+(repetition-1)+' / '+numberOfRepetitions+'...');
				
				let stopCondition = {'type': 'reachFailstack', 'targetStack': level}
				
				for(let i=repetition; i<repetition+50; i++) {
					
					if(i > numberOfRepetitions) {
						let timeEnd = new Date().getTime();
						$("#logs").prepend("<p>... fs"+level+" Duration: "+String((timeEnd-timeStart)*1.0/1000)+"s Repetitions: "+String(numberOfRepetitions)+"</p>");
						
						failstackCosts[level] = -totalProfitTax;
						updateFailstackCostsDisplay();
						
						level++;
						repetition = 1-50;
						myItem = createItem(arrayOfSteps[0].name, arrayOfSteps[0].rank);
						componentsUsed = {};
						itemsProduced = {};
						timeStart = new Date().getTime();
						break;
					}
				
					currentFailstack = playerSettings['permanentFailstack'];
					runStrategy(stopCondition, arrayOfSteps);
					
					updateDisplay(); // Prices are computed during during this function call
				}
				
				if(level > maxLevel) {
					let failstackComputeTimeEnd = new Date().getTime();
					$("#isRunning").hide();
					$("#logs").prepend("<p>... All "+maxLevel+" levels completed in "+String((failstackComputeTimeEnd-failstackComputeTimeStart)*1.0/1000)+"s</p>");
					return;
				}
				
				setTimeout(function() {
					runFailstackLevel(level, maxLevel, repetition+50, arrayOfSteps);
				},10);
			}
			
			let displayOnOff = true; // True = On, False = Off
			let numberOfRepetitions = 1;
			let timeStart, failstackComputeTimeStart;
			let typeOfDisplay = 'average';
			let modeEditComponents = false;
			let modeEditItems = false;
			let modeEditPlayerSettings = false;
			let failstackIncreases = [1,1,1,1,1,  1,1,1,1,1,  1,1,1,1,1,  1,3,4,5,6, 0];
			let autoPurifyReblath15 = true;
			let naderr = [];
			let typeOfStrategyDisplayed = 'failstackMode'; // Or 'singleItemMode'
			
			let allItems = {
				'Militia': {
					'base': [100,100,100,100,100,  100,100,70,20.41,14.29,  10,6.67,4,2.5,2,  11.76,7.69,6.25,2.00,0.30, 0],
					'durabilityLoss': 5.0,
					'durabilityLoss2': 10.0,
					'durabilityRegenItem': 'militia',
					'durabilityRegen': 10.0,
					'componentType': 'weaponStone',
					'componentType2': 'concentratedWeaponStone',
					'componentCount': [1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1]
				},
				'Reblath': {
					'base': [100,100,100,100,100,  70,25.64,17.24,11.76,7.69,   6.25,5,4,2.86,2,  11.76,7.69,6.25,2.00,0.30, 0],
					'durabilityLoss': 5.0,
					'durabilityLoss2': 10.0,
					'durabilityRegenItem': 'reblath',
					'durabilityRegen': 10.0,
					'componentType': 'armorStone',
					'componentType2': 'concentratedArmorStone',
					'componentCount': [1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1]
				},
				'Tuvala Weapon': {
					'base': [100,100,100,100,100, 100,100,90,70,50, 30,20,15,10,8, 17,12,8,5,3, 0],
					'durabilityLoss': 5.0,
					'durabilityLoss2': 5.0,
					'durabilityRegenItem': 'tuvalaOre',
					'durabilityRegen': 10.0,
					'componentType': 'timeFilledStone',
					'componentType2': 'timeFilledStone',
					'componentCount': [15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15, 15]
				},
				'Tuvala Armor': {
					'base': [100,100,100,100,100, 90,80,70,60,50, 30,20,15,10,8, 17,12,8,5,3, 0],
					'durabilityLoss': 5.0,
					'durabilityLoss2': 5.0,
					'durabilityRegenItem': 'tuvalaOre',
					'durabilityRegen': 10.0,
					'componentType': 'timeFilledStone',
					'componentType2': 'timeFilledStone',
					'componentCount': [15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15, 15]
				},
				'Green Weapon': { // Quite different, neraly all have x2 probability and 3x for +13 and +14. Same once at +15
					'base': [100,100,100,100,100,  100,100,70,40.82,28.58,  20,13.34,8,7.5,6,  11.76,7.69,6.25,2.00,0.30, 0],
					'durabilityLoss': 5.0,
					'durabilityLoss2': 10.0,
					'durabilityRegenItem': 'greenWeapon',
					'durabilityRegen': 10.0,
					'componentType': 'weaponStone',
					'componentType2': 'concentratedWeaponStone',
					'componentCount': [1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1]
				},
				'Green Armor': { // Difference with White/Blue/Yellow: 51.28 and 3.75
					'base': [100,100,100,100,100,  70,51.28,17.24,11.76,7.69,   6.25,5,4,3.75,2,  11.76,7.69,6.25,2.00,0.30, 0],
					'durabilityLoss': 5.0,
					'durabilityLoss2': 10.0,
					'durabilityRegenItem': 'greenArmor',
					'durabilityRegen': 10.0,
					'componentType': 'armorStone',
					'componentType2': 'concentratedArmorStone',
					'componentCount': [1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1]
				},
				'Yellow Weapon': { // Copy of white but with mems
					'base': [100,100,100,100,100,  100,100,70,20.41,14.29,  10,6.67,4,2.5,2,  11.76,7.69,6.25,2.00,0.30, 0],
					'durabilityLoss': 5.0,
					'durabilityLoss2': 10.0,
					'durabilityRegenItem': 'memoryFragment',
					'durabilityRegen': 1.0,
					'componentType': 'weaponStone',
					'componentType2': 'concentratedWeaponStone',
					'componentCount': [1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1]
				},
				'Yellow Armor': { // Copy of white but with mems
					'base': [100,100,100,100,100,  70,25.64,17.24,11.76,7.69,   6.25,5,4,2.86,2,  11.76,7.69,6.25,2.00,0.30, 0],
					'durabilityLoss': 5.0,
					'durabilityLoss2': 10.0,
					'durabilityRegenItem': 'memoryFragment',
					'durabilityRegen': 1.0,
					'componentType': 'armorStone',
					'componentType2': 'concentratedArmorStone',
					'componentCount': [1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1]
				},
				'Blackstar Weapon': { // Same below +15, different durability losses, 10 then 20
					'base': [100,100,100,100,100,  100,100,70,20.41,14.29,  10,6.67,4,2.5,2,  13.08,10.63,3.40,0.51,0.20, 0],
					'durabilityLoss': 10.0,
					'durabilityLoss2': 20.0,
					'durabilityRegenItem': 'memoryFragment',
					'durabilityRegen': 1.0,
					'componentType': 'concentratedMagicalStone',
					'componentType2': 'flawlessMagicalStone',
					'componentCount': [1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1]
				},
				'Blackstar Armor': { // Same below +15 as normal armor, same as Blackstar weapon after that
					'base': [100,100,100,100,100,  70,25.64,17.24,11.76,7.69,   6.25,5,4,2.86,2,  13.08,10.63,3.40,0.51,0.20, 0],
					'durabilityLoss': 10.0,
					'durabilityLoss2': 20.0,
					'durabilityRegenItem': 'memoryFragment',
					'durabilityRegen': 1.0,
					'componentType': 'concentratedMagicalStone',
					'componentType2': 'flawlessMagicalStone',
					'componentCount': [1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1]
				},
				'Green Ship Part': {
					'base': [70,60,50,45,40,  37,35,33,31,30,   0,0,0,0,0,  0,0,0,0,0, 0],
					'durabilityLoss': 5.0,
					'durabilityLoss2': 10.0,
					'durabilityRegenItem': 'memoryFragment',
					'durabilityRegen': 5.0,
					'componentType': 'fieryBlackStone',
					'componentType2': 'frostedBlackStone',
					'componentCount': [1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1],
					'stage2Rank': 5
				},
				'Blue Ship Part': {
					'base': [30,25,20,15,12,  10,5,3,2,1,   0,0,0,0,0,  0,0,0,0,0, 0],
					'durabilityLoss': 5.0,
					'durabilityLoss2': 10.0,
					'durabilityRegenItem': 'memoryFragment',
					'durabilityRegen': 2.0,
					'componentType': 'fieryBlackStone',
					'componentType2': 'frostedBlackStone',
					'componentCount': [1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1],
					'stage2Rank': 5
				},
				'GBY Accessory': {
					'base': [25, 10, 7.5, 2.5, 0.5, 0],
					'softcap': [70, 50, 40, 30, 25, 0],
					'type': 'accessory'
				}
			};
			
			componentPrices = {
				'weaponStone': 120000,
				'armorStone': 118000,
				'concentratedWeaponStone': 2190000,
				'concentratedArmorStone': 1870000,
				'sharpFragment': 1570000,
				'hardFragment': 1290000,
				
				'concentratedMagicalStone': 10000000,
				'flawlessMagicalStone': 100000000,
				
				'fieryBlackStone': 0,
				'frostedBlackStone': 0,
				
				'memoryFragment': 2100000,
				
				'militia': 13400,
				'reblath': 12900,
				'greenWeapon':24900,
				'greenArmor':27000,
				
				'purify': 100000
			}
			
			function computeConcentratedFromMaterials () {
				componentPrices['concentratedWeaponStone'] = componentPrices['sharpFragment'] + componentPrices['weaponStone']*2;
				componentPrices['concentratedArmorStone'] = componentPrices['hardFragment'] + componentPrices['armorStone']*2;
			}
			computeConcentratedFromMaterials();
			
			itemPrices = {
				'[Green Weapon (PRI)]': 38800000,
				'[Green Weapon (DUO)]': 47600000,
				'[Green Weapon (TRI)]': 128000000,
				'[Green Weapon (TET)]': 431000000,
				'[Green Weapon (PEN)]': 715000000,
				'[Green Armor (PRI)]': 38800000,
				'[Green Armor (DUO)]': 47600000,
				'[Green Armor (TRI)]': 128000000,
				'[Green Armor (TET)]': 431000000,
				'[Green Armor (PEN)]': 715000000,
				'[Yellow Weapon (PRI)]': 418000000,
				'[Yellow Weapon (DUO)]': 465000000,
				'[Yellow Weapon (TRI)]': 525000000,
				'[Yellow Weapon (TET)]': 1440000000,
				'[Yellow Weapon (PEN)]': 14500000000,
				'[Yellow Armor (PRI)]': 895000000,
				'[Yellow Armor (DUO)]': 990000000,
				'[Yellow Armor (TRI)]': 1380000000,
				'[Yellow Armor (TET)]': 2900000000,
				'[Yellow Armor (PEN)]': 21600000000,
				'[Blackstar Weapon (PRI)]': 1650000000,
				'[Blackstar Weapon (DUO)]': 1880000000,
				'[Blackstar Weapon (TRI)]': 2420000000,
				'[Blackstar Weapon (TET)]': 12100000000,
				'[Blackstar Weapon (PEN)]': 92000000000,
				'[Blackstar Armor (PRI)]': 2070000000,
				'[Blackstar Armor (DUO)]': 2240000000,
				'[Blackstar Armor (TRI)]': 2800000000,
				'[Blackstar Armor (TET)]': 12300000000,
				'[Blackstar Armor (PEN)]': 48800000000,
				'[GBY Accessory (0)]': 64500000,
				'[GBY Accessory (PRI)]': 175000000,
				'[GBY Accessory (DUO)]': 590000000,
				'[GBY Accessory (TRI)]': 1830000000,
				'[GBY Accessory (TET)]': 7950000000,
				'[GBY Accessory (PEN)]': 73000000000
			}
			
			failstackCosts = {
			}
			
			let playerSettings = {
				'permanentFailstack': 1,
				'accessoryResetRank': 'PRI'
			};
			
			
			let currentFailstack = playerSettings['permanentFailstack'];
			
			/*let componentsUsed = {
				'weaponStone': 0,
				'armorStone': 0,
				'concentratedWeaponStone': 0,
				'concentratedArmorStone': 0,
				
				'memoryFragment': 0,
				
				'militia': 0,
				'reblath': 0,
				'greenArmor':0,
				
				'purify': 0
			};*/
			
			let componentsUsed = {};
			let itemsProduced = {};
			
			let componentCosts = {};
			let itemProfitsNoTax = {};
			let itemProfitsTax = {};
			
			let totalComponentCosts;
			let totalItemProfitsNoTax;
			let totalItemProfitsTax;
			
			let totalProfitNoTax;
			let totalProfitTax;
			let marketTaxFactor = 0.85;
			
			let failstacksUsed = {};
			let failstacksUsedCosts = {};
			let totalFailstacksUsedCost = 0;
			
			
			class Item {
				//rawRank should be a string in PEN format
				//this.rank is a number in 20 format
				constructor(name, rankPen) {
					this.name = name;
					this.type ='item';
					this.item = allItems[this.name];
					this.rank = Item.rankTo20(rankPen);
					this.base = allItems[this.name]['base'][this.rank];
					this.stage2Rank = (allItems[this.name]['stage2Rank'] == undefined) ? 15 : allItems[this.name]['stage2Rank'];
					objAdd(itemsProduced, this.toString(), -1);
					if(displayOnOff) $('#logs').prepend('<p style="color: brown">'+this.toString()+' bought</p>');
				}
				
				sell() {
					objAdd(itemsProduced, this.toString(), 1);
					if(displayOnOff) $('#logs').prepend('<p style="color: brown">'+this.toString()+' sold</p>');
				}
				
				static rankToPen(rank) {
					if(rank == 16) return 'PRI';
					if(rank == 17) return 'DUO';
					if(rank == 18) return 'TRI';
					if(rank == 19) return 'TET';
					if(rank == 20) return 'PEN';
					return String(rank);
				}
				
				static rankTo20(rank) {
					if(rank == 'PRI') return 16;
					if(rank == 'DUO') return 17;
					if(rank == 'TRI') return 18;
					if(rank == 'TET') return 19;
					if(rank == 'PEN') return 20;
					return Number(rank);
				}
				
				rankToPen() {
					return Item.rankToPen(this.rank);
				}
				
				rankTo20() {
					return this.rank;
				}
				
				static computeEnhanceProba(base, failstack) {
					let proba = base;
					for(let i=0; i<failstack; i++) {
						if(proba < 70) {
							proba += base/10;
						} else if(proba>=70 && proba<90) {
							proba += base/50
						}
					}
					return proba.toFixed(3);
				}
				
				enhance() {
					//global: currentFailstack
					let proba = Item.computeEnhanceProba(this.base, currentFailstack);
					let roll = Math.random() * 100;
					
					let componentType = (this.rank < this.stage2Rank) ? this.item['componentType'] : this.item['componentType2'];
					
					if(roll < proba) {
						let logTxt = `Enhance ${this.toString()} +${currentFailstack} ${proba}% SUCCESS`;
						if(displayOnOff) $('#logs').prepend('<p style="color: green">'+logTxt+'</p>');
						
						currentFailstack = playerSettings['permanentFailstack'];
						
						objAdd(componentsUsed, componentType, this.item['componentCount'][this.rank]);
						//objAdd(itemsProduced, this.toString(), -1);
						this.rank += 1;
						//objAdd(itemsProduced, this.toString(), 1);
						this.base = allItems[this.name]['base'][this.rank];
						return "success";
					} else {
						let logTxt = `Enhance ${this.toString()} +${currentFailstack} ${proba}% FAIL`;
						if(displayOnOff) $('#logs').prepend('<p style="color: red">'+logTxt+'</p>');
						//console.log(logTxt);
						
						currentFailstack += failstackIncreases[this.rank];
						objAdd(componentsUsed, componentType, this.item['componentCount'][this.rank]);
						let durabilityLoss = (this.rank < this.stage2Rank) ? this.item['durabilityLoss'] : this.item['durabilityLoss2'];
						objAdd(componentsUsed, this.item['durabilityRegenItem'], durabilityLoss / this.item['durabilityRegen']);
						if(this.rank >= Item.rankTo20("DUO")) {
							this.rank -= 1;
							
							this.base = allItems[this.name]['base'][this.rank];
						}
						return "fail";
					}
				}
				
				purify() {
					if(this.rank == 0) {
						if(displayOnOff) $('#logs').prepend('<p style="color: pink">Already rank 0, nothing done</p>');
						return;
					}
					if(displayOnOff) $('#logs').prepend('<p style="color: pink">'+this.toString()+' purified</p>');
					objAdd(componentsUsed, 'purify', 1);
					
					this.rank -=1;
					
					this.base = allItems[this.name]['base'][this.rank];
				}
				
				toString() {
					return `[${this.name} (${this.rankToPen()})]`;
				}
				
				toInfoString() {
					return `[${this.name} (${this.rankToPen()})] Base: ${this.base} `;
				}
				
				toDisplay() {
					let componentType = (this.rank < this.stage2Rank) ? this.item['componentType'] : this.item['componentType2'];
					let durabilityLoss = (this.rank < this.stage2Rank) ? this.item['durabilityLoss'] : this.item['durabilityLoss2'];
					return `[${this.name} (${this.rankToPen()})]<br><br>
					Success : ${Item.computeEnhanceProba(this.base, currentFailstack)}%<br><br>
					${this.item['componentCount'][this.rank]}x ${componentType} used per attempt<br>
					${durabilityLoss} durability lost on failure<br>
					${this.item['durabilityRegen']} durability recovered per ${this.item['durabilityRegenItem']}`;
				}
			}
			
			class Accessory {
				constructor(name, rankPen) {
					this.name = name;
					this.type ='accessory';
					this.item = allItems[this.name];
					this.rank = Accessory.rankTo20(rankPen);
					this.base = allItems[this.name]['base'][this.rank];
					this.softcap = allItems[this.name]['softcap'][this.rank];
					objAdd(itemsProduced, this.toString(), -1);
					if(displayOnOff) $('#logs').prepend('<p style="color: brown">'+this.toString()+' bought</p>');
				}
				
				sell() {
					objAdd(itemsProduced, this.toString(), 1);
					if(displayOnOff) $('#logs').prepend('<p style="color: brown">'+this.toString()+' sold</p>');
				}
				
				static rankToPen(rank) {
					if(rank == 1) return 'PRI';
					if(rank == 2) return 'DUO';
					if(rank == 3) return 'TRI';
					if(rank == 4) return 'TET';
					if(rank == 5) return 'PEN';
					return '0';
				}
				
				static rankTo20(rank) {
					if(rank == 'PRI') return 1;
					if(rank == 'DUO') return 2;
					if(rank == 'TRI') return 3;
					if(rank == 'TET') return 4;
					if(rank == 'PEN') return 5;
					return 0;
				}
				
				rankToPen() {
					return Accessory.rankToPen(this.rank);
				}
				
				rankTo20() {
					return this.rank;
				}
				
				static computeEnhanceProba(base, softcap, failstack) {
					let proba = base;
					for(let i=0; i<failstack; i++) {
						if(proba < softcap) {
							proba += base/10;
						} else if(proba>=softcap && proba<90) {
							proba += base/50
						}
					}
					return proba.toFixed(3);
				}
				
				enhance() {
					//global: currentFailstack
					let proba = Accessory.computeEnhanceProba(this.base, this.softcap, currentFailstack);
					let roll = Math.random() * 100;
					
					let componentType = `[${this.name} (0)]`;
					
					if(roll < proba) {
						let logTxt = `Enhance ${this.toString()} +${currentFailstack} ${proba}% SUCCESS`;
						if(displayOnOff) $('#logs').prepend('<p style="color: green">'+logTxt+'</p>');
						
						currentFailstack = playerSettings['permanentFailstack'];
						
						objAdd(itemsProduced, componentType, -1);
						
						this.rank += 1;
						
						this.base = allItems[this.name]['base'][this.rank];
						this.softcap = allItems[this.name]['softcap'][this.rank];
						return "success";
					} else {
						let logTxt = `Enhance ${this.toString()} +${currentFailstack} ${proba}% FAIL`;
						if(displayOnOff) $('#logs').prepend('<p style="color: red">'+logTxt+'</p>');
						
						currentFailstack += 1;
						objAdd(itemsProduced, componentType, -1);
						
						this.rank = Accessory.rankTo20(playerSettings['accessoryResetRank']);
						objAdd(itemsProduced, `[${this.name} (${Accessory.rankToPen(this.rank)})]`, -1);
						this.base = allItems[this.name]['base'][this.rank];
						this.softcap = allItems[this.name]['softcap'][this.rank];
						if(displayOnOff) $('#logs').prepend('<p style="color: brown">Restart: '+this.toString()+' bought</p>');
						return "fail";
					}
				}
				
				purify() {
					if(this.rank == 0) {
						if(displayOnOff) $('#logs').prepend('<p style="color: pink">Already rank 0, nothing done</p>');
						return;
					}
					if(displayOnOff) $('#logs').prepend('<p style="color: pink">'+this.toString()+' purified</p>');
					objAdd(componentsUsed, 'purify', 1);
					//objAdd(itemsProduced, this.toString(), -1);
					this.rank -=1;
					//objAdd(itemsProduced, this.toString(), 1);
					this.base = allItems[this.name]['base'][this.rank];
					this.softcap = allItems[this.name]['softcap'][this.rank];
				}
				
				toString() {
					return `[${this.name} (${this.rankToPen()})]`;
				}
				
				toInfoString() {
					return `[${this.name} (${this.rankToPen()})] Base: ${this.base} `;
				}
				
				toDisplay() {
					return `[${this.name} (${this.rankToPen()})]<br><br>
					Success : ${Accessory.computeEnhanceProba(this.base, this.softcap, currentFailstack)}%`;
				}
			}
			
			function createItem(name, rankPen) {
				if(allItems[name].type == 'accessory') return new Accessory(name, rankPen)
				else return new Item(name, rankPen);
			}
			
			function getType(name) {
				return (allItems[name].type == 'accessory') ? 'accessory' : 'item';
			}
			
			function getRankToPen(rank, type) {
				return (type == 'accessory') ? Accessory.rankToPen(rank) : Item.rankToPen(rank);
			}
			
			function getRankTo20(rank, type) {
				return (type == 'accessory') ? Accessory.rankTo20(rank) : Item.rankTo20(rank);
			}
			
			// Be careful, Table head is index 0
			// Be also careful, for some reason nth-child seems to start at 1 for index 0 ...
			function addStep(newStartStep, name, rankPen, index) {
				let newStep = $($("#sampleStep :first-child").html());
				
				if(index == undefined) index = $("#steps tr").length-1;
				
				index++; // Correcting the weird indexing of nth-child
				
				newStep.find("input").val(newStartStep);
				newStep.find("select").first().find("option[value=\""+name+"\"]").prop("selected", true);
				newStep.find("select").last().find("option[value=\""+rankPen+"\"]").prop("selected", true);
				
				$(`#steps tr:nth-child(${index})`).after(newStep);
			}
			
			function deleteAllStrategies() {
				$("#steps tr").not(":first").remove();
			}
			
			function setStopConditionType(newType) {
				if(newType == 'reachFailstack') {
					$("#stopConditionType").find("option[value=\"reachFailstack\"]").prop("selected", true);
					$('#stopConditionTargetStack').show();
				} else {
					$("#stopConditionType").find("option[value=\"successOnLastStep\"]").prop("selected", true);
					$('#stopConditionTargetStack').hide();
				}
			}
			setStopConditionType('reachFailstack');
			
			deleteAllStrategies();
			addStep(0, "Reblath", "14");
			addStep(20, "Green Armor", "PRI");
			addStep(30, "Green Armor", "DUO");
			addStep(50, "Green Armor", "TRI");
			addStep(70, "Green Armor", "TET");
			setStopConditionType("reachFailstack");
			$("#stopConditionTargetStack").val(100);
			
			
			
			
			function getComponentPrice(key) {
				return (componentPrices[key] != undefined) ? componentPrices[key] : 0;
			}
			function getItemPrice(key) {
				return (itemPrices[key] != undefined) ? itemPrices[key] : 0;
			}
			function computeCosts(componentsUsedDisplayed, itemsProducedDisplayed, failstacksUsedDisplayed) {
				totalComponentCosts = 0;
				totalItemProfitsNoTax = 0;
				totalItemProfitsTax = 0;
				
				
				for (let [key, value] of Object.entries(componentsUsedDisplayed)) {
					let cost = getComponentPrice(key) * value;
					componentCosts[key] = cost;
					totalComponentCosts += cost;
				}
				for (let [key, value] of Object.entries(itemsProducedDisplayed)) {
					let profit = getItemPrice(key) * value;
					itemProfitsNoTax[key] = profit;
					itemProfitsTax[key] = ((profit>0) ? marketTaxFactor : 1) * profit;
					totalItemProfitsNoTax += profit;
					totalItemProfitsTax += ((profit>0) ? marketTaxFactor : 1) * profit;
				}
				
				
				failstacksUsedCosts = {};
				totalFailstacksUsedCost = 0;
				for (let [key, value] of Object.entries(failstacksUsedDisplayed)) {
					
					let cost = failstacksUsedDisplayed[key] * ((failstackCosts[key] == undefined) ? 0.0 : failstackCosts[key]);
					failstacksUsedCosts[key] = cost;
					totalFailstacksUsedCost += cost;
				}
				
				totalProfitNoTax = totalItemProfitsNoTax - totalComponentCosts - totalFailstacksUsedCost;
				totalProfitTax = totalItemProfitsTax - totalComponentCosts - totalFailstacksUsedCost;
			}
			
			function updateDisplay() {
				let componentsUsedDisplayed = {};
				let itemsProducedDisplayed = {};
				let failstacksUsedDisplayed = {};
				if(typeOfDisplay == "cumulative") {
					componentsUsedDisplayed = componentsUsed;
					itemsProducedDisplayed = itemsProduced;
					failstacksUsedDisplayed = failstacksUsed;
				} else {
					for (let [key, value] of Object.entries(componentsUsed)) {
						componentsUsedDisplayed[key] = value * (1.0) / numberOfRepetitions;
					}
					for (let [key, value] of Object.entries(itemsProduced)) {
						itemsProducedDisplayed[key] = value * (1.0) / numberOfRepetitions;
					}
					for (let [key, value] of Object.entries(failstacksUsed)) {
						failstacksUsedDisplayed[key] = value * (1.0) / numberOfRepetitions;
					}
				}
				
				
				computeCosts(componentsUsedDisplayed, itemsProducedDisplayed, failstacksUsedDisplayed);
				
				$('#myItem').html('<p>'+myItem.toDisplay()+'</p>');
				$('#currentFailstack').html('<p>Failstack: +'+currentFailstack+'</p>');
				
				$('#componentsUsed').html('');
				$('#componentsUsed').append('<tr><th>Name</th><th></th><th>Cost</th></tr>');
				for (let [key, value] of Object.entries(componentsUsedDisplayed)) {
					$('#componentsUsed').append('<tr><td>'+key+'</td><td>'+String(value.toFixed(2))+'</td><td>'+displayCompactNumber(componentCosts[key])+'</td></tr>');
				}
				$('#componentsUsed').append('<tr><td>Total</td><td></td><td>'+displayCompactNumber(totalComponentCosts)+'</td></tr>');
				
				$('#itemsProduced').html('');
				$('#itemsProduced').append('<tr><th>Name</th><th></th><th>No tax</th><th>Taxed</th></tr>');
				for (let [key, value] of Object.entries(itemsProducedDisplayed)) {
					$('#itemsProduced').append('<tr><td>'+key+'</td><td>'+String(value.toFixed(2))+'</td><td>'+displayCompactNumber(itemProfitsNoTax[key])+'</td><td>'+displayCompactNumber(itemProfitsTax[key])+'</td></tr>');
				}
				$('#itemsProduced').append('<tr><td>Total</td><td></td><td>'+displayCompactNumber(totalItemProfitsNoTax)+'</td><td>'+displayCompactNumber(totalItemProfitsTax)+'</td></tr>');
				$('#itemsProduced').append('<tr><th>Total (items - components - failstacks)</th><th></th><th>'+displayCompactNumber(totalProfitNoTax)+'</th><th>'+displayCompactNumber(totalProfitTax)+'</th></tr>');
				
				$('#naderr').html(JSON.stringify(naderr));
				
				$('#failstacksUsed').html('');
				for (let [key, value] of Object.entries(failstacksUsedDisplayed)) {
					$('#failstacksUsed').append('<tr><td>'+key+'</td><td>'+String(value.toFixed(2))+'</td><td>'+displayCompactNumber(failstacksUsedCosts[key])+'</td></tr>');
				}
				$('#failstacksUsed').append('<tr><td>Total</td><td></td><td>'+displayCompactNumber(totalFailstacksUsedCost)+'</td></tr>');
			}
			
			function updateFailstackCostsDisplay() {
				$('#failstackCosts').html('');
				$('#failstackCosts').append('<tr><th>Failstack</th><th>Cost taxed</th></tr>');
				for (let [key, value] of Object.entries(failstackCosts)) {
					$('#failstackCosts').append('<tr><td>'+key+'</td><td>'+displayCompactNumber(value)+'</td></tr>');
				}
			}
			
			function saveComponentPrices() {
				for (let [key, value] of Object.entries(componentPrices)) {
					componentPrices[key] = Number($('#'+key+'ComponentPriceInput').val());
				}
				updateSettings();
			}
			
			// Replace is used so Ids only contain a-zA-Z0-9 ... there was probably a simpler method
			function saveItemPrices() {
				for (let [key, value] of Object.entries(itemPrices)) {
					itemPrices[key] = Number($('#'+(key.replace("[", "aaa").replace("]", "bbb").replace("(", "ccc").replace(")", "ddd").replace(/ /g, "eee"))+'ItemPriceInput').val());
				}
				updateSettings();
			}
			
			function savePlayerSettings() {
				for (let [key, value] of Object.entries(playerSettings)) {
					let newValue = $('#'+key+'PlayerSettingsInput').val()
					let formattedValue = (key == 'permanentFailstack') ? Number(newValue) : newValue;
					playerSettings[key] = formattedValue;
				}
				updateSettings();
			}
			
			function displayCompactNumber(myNumber) {
				let sign = (myNumber >= 0) ? '' : '-';
				myNumber = Math.abs(myNumber);
				if(myNumber > 1e9) return sign + String((myNumber/1e9).toFixed(2))+' G silver';
				if(myNumber > 1e6) return sign + String((myNumber/1e6).toFixed(2))+' M silver';
				if(myNumber > 1e3) return sign + String((myNumber/1e3).toFixed(2))+' k silver';
				return sign + String(myNumber.toFixed(3))+' silver';
			}
			function updateSettings() {
				if(modeEditComponents) {
					$('#componentPrices').html('');
					for (let [key, value] of Object.entries(componentPrices)) {
						$('#componentPrices').append('<tr><td>'+key+'</td><td><input type="text" value="'+value+'" id="'+key+'ComponentPriceInput"></td></tr>');
					}
				} else {
					$('#componentPrices').html('');
					for (let [key, value] of Object.entries(componentPrices)) {
						$('#componentPrices').append('<tr><td>'+key+'</td><td>'+displayCompactNumber(value)+'</td></tr>');
					}
				}
				
				if(modeEditItems) {
					$('#itemPrices').html('');
					for (let [key, value] of Object.entries(itemPrices)) {
						$('#itemPrices').append('<tr><td>'+key+'</td><td><input type="text" value="'+value+'" id="'+(key.replace("[", "aaa").replace("]", "bbb").replace("(", "ccc").replace(")", "ddd").replace(/ /g, "eee"))+'ItemPriceInput"></td></tr>');
					}
				} else {
					$('#itemPrices').html('');
					for (let [key, value] of Object.entries(itemPrices)) {
						$('#itemPrices').append('<tr><td>'+key+'</td><td>'+displayCompactNumber(value)+'</td></tr>');
					}
				}
				
				if(modeEditPlayerSettings) {
					$('#playerSettings').html('');
					for (let [key, value] of Object.entries(playerSettings)) {
						$('#playerSettings').append('<tr><td>'+key+'</td><td><input type="text" value="'+value+'" id="'+key+'PlayerSettingsInput"></td></tr>');
					}
				} else {
					$('#playerSettings').html('');
					for (let [key, value] of Object.entries(playerSettings)) {
						$('#playerSettings').append('<tr><td>'+key+'</td><td>'+value+'</td></tr>');
					}
				}
			}
			
			updateSettings();
			
			function toggleDisplayOnOff() {
				displayOnOff = !displayOnOff;
				$("#displayOnOff").html(displayOnOff ? "All steps displayed (slow)" : "Only summaries displayed (fast)");
			}
			
			
			
			
			
			function runStrategy(stopCondition, arrayOfSteps) {
				//global: currentFailstack
				
				if(displayOnOff) $('#logs').prepend('<p>>>>Run strategy: stopCondition='+JSON.stringify(stopCondition)+' steps='+JSON.stringify(arrayOfSteps)+'</p>');
				
				if(arrayOfSteps.length == 0) {
					if(displayOnOff) $('#logs').prepend('<p style="color: red"><b>No step in the strategy. Run terminated without reaching the stop condition</b></p>');
					return;
				}
				
				myItem = createItem(arrayOfSteps[0].name, arrayOfSteps[0].rank);
				while(true) {
					if( (stopCondition.type == "reachFailstack" && currentFailstack >= stopCondition.targetStack)
						|| (
							stopCondition.type == "successOnLastStep"
							&& myItem.name == arrayOfSteps[arrayOfSteps.length-1].name
							&& myItem.rank == (getRankTo20(arrayOfSteps[arrayOfSteps.length-1].rank, myItem.type) + 1)
						)
					) {
						myItem.sell();
						break;
					}
					
					// Get through in decreasing order
					let somethingHappened = false;
					for(let i = arrayOfSteps.length-1; i>=0; i--) {
						let step = arrayOfSteps[i];
						if(autoPurifyReblath15 && myItem.name == 'Reblath' && myItem.rank == 15) myItem.purify();
						
						if(currentFailstack >= step.startStep) {
							somethingHappened = true;
							if(myItem.name != step.name || myItem.rank != getRankTo20(step.rank, myItem.type)) {
								myItem.sell();
								myItem = createItem(step.name, step.rank);
							}
							myItem.enhance();
							break;
						}
					}
					if(!somethingHappened) {
						if(displayOnOff) $('#logs').prepend('<p style="color: red"><b>Conditions met for none of the steps. Run terminated without reaching the stop condition</b></p>');
						return;
					}
				}
				
				if(displayOnOff) $('#logs').prepend('<p>... Strategy run completed: stopCondition='+JSON.stringify(stopCondition)+' steps='+JSON.stringify(arrayOfSteps)+'</p>');
			}
			
			function runSingleItemStrategy(name, startRankPen, goalRankPen, arrayOfSteps) {
				//global: currentFailstack
				
				if(displayOnOff) $('#logs').prepend('<p>>>>Run single item strategy: name='+name+' start='+startRankPen+' goal='+goalRankPen+' steps='+JSON.stringify(arrayOfSteps)+'</p>');
				
				if(arrayOfSteps.length == 0) {
					if(displayOnOff) $('#logs').prepend('<p style="color: red"><b>No step in the strategy. Run terminated</b></p>');
					return;
				}
				
				myItem = createItem(name, startRankPen);
				
				startRank = getRankTo20(startRankPen, myItem.type);
				goalRank = getRankTo20(goalRankPen, myItem.type);
				
				
				
				while(true) {
					if(myItem.rank == goalRank) {
						myItem.sell();
						break;
					}
					
					let stepIndex = myItem.rank-startRank;
					let startStack = Number(arrayOfSteps[stepIndex]);
					let nextStack = (myItem.rank+1 == goalRank) ? 99999 : Number(arrayOfSteps[stepIndex+1]);
					
					if(currentFailstack >= nextStack) {
						naderr.push(currentFailstack);
						naderr.sort(function(a, b){return a - b});
						if(displayOnOff) $('#logs').prepend('<p style="color: rgb(75, 129, 232)">Store failstack of +'+currentFailstack+' in Naderr\'s belt '+JSON.stringify(naderr)+'</p>');
						currentFailstack = playerSettings['permanentFailstack'];
					}
					
					if(currentFailstack < startStack) {
						for(let i=naderr.length-1; i>=0; i--) {
							if(naderr[i] >= startStack && naderr[i] < nextStack) {
								currentFailstack = naderr[i];
								naderr.splice(i, 1); // remove i-th element
								if(displayOnOff) $('#logs').prepend('<p style="color: rgb(75, 129, 232)">Retrieve failstack of +'+currentFailstack+' from Naderr\'s belt '+JSON.stringify(naderr)+'</p>');
								break;
							}
						}
					}
					
					if(currentFailstack < startStack) {
						currentFailstack = startStack;
						failstacksUsed[startStack] = (failstacksUsed[startStack] == undefined) ? 1 : failstacksUsed[startStack]+1;
						if(displayOnOff) $('#logs').prepend('<p style="color: rgb(75, 129, 232)">Load failstack +'+startStack+'</p>');
					}
					
					myItem.enhance();
				}
				
				if(displayOnOff) $('#logs').prepend('<p>... Single item strategy run completed: name='+name+' start='+startRankPen+' goal='+goalRankPen+' steps='+JSON.stringify(arrayOfSteps)+'</p>');
			}
			
			//reachFailstackReblath(30);
			//updateDisplay();
			
			
			//reachFailstackGreenArmor(100, [20,30,50,70]);
			//updateDisplay();
			$("#isRunning").show();
			timeStart = new Date().getTime();
			runRepetition(1, runStrategy, [{"type":"reachFailstack","targetStack":"100"}, [
					{"startStep":"0","name":"Reblath","rank":"14"},
					{"startStep":"20","name":"Green Armor","rank":"PRI"},
					{"startStep":"30","name":"Green Armor","rank":"DUO"},
					{"startStep":"50","name":"Green Armor","rank":"TRI"},
					{"startStep":"70","name":"Green Armor","rank":"TET"}
				]
			]);
		</script>
		
		<div id="changeLogs" style="display:none">
			<p>
				<strong>Contact me:</strong> Family name (EU) Bvic<br>
				<em>Don't hesitate to send me a message if you find this tool useful, so I get the motivation to keep improving it!</em><br>
				
				<br>TODO:<br>
				- Optimise a strategy by finding the best FS level for each step.<br>
				- Compute the time spent clicking/going to the church/buying from the market/loading from the warehouse.<br>
				- Enter the data for less common items like manos and ship equipment.<br>
				
				<br>v0.6: (24/05/2021)<br>
				- Handles GBY accessories. No Manos and similar items yet.<br>
				
				<br>v0.5.1: (23/05/2021)<br>
				- Ship green and blue gear added. Slight modification to allow the change in component and durability decrease at either rank 5 or 15.<br>
				
				<br>v0.5: (18/05/2021)<br>
				- Single item strategy.<br>
				
				<br>v0.4: (16/05/2021)<br>
				- Compute the cost of failstacks.<br>
				
				
				<br>v0.3.1: (14/05/2021)<br>
				- Handle the permanent failstack from the adventure log.<br>
				- No infinite loop when no step is valid.<br>
				- Button compute the price of concentrated black stones from materials.<br>
				
				<br>v0.3: (12/05/2021)<br>
				- Add Yellow/blackstar<br>
				- Handle properly the different materials and durability loss for below +14 and above +15.<br>
				- Warning : I didn't check the numbers for componentCount, durabilityLoss and durabilityRegen myself.<br>
				
				<br>v0.2: (10/05/2021)<br>
				- 100x faster: Allow disabling endless logs.<br>
				- Asynchronous computing to avoid freezing the window.<br>
				- Change logs added!<br>
				- Custom strategies. It only handles reaching a failstack or enhancement success of the last item of the list. It doesn't handle enhancing a single item through all ranks.<br>
				- Uploaded on Github.<br>
				
				<br>v0.1: (08/05/2021)<br>
				- First version! Reblath and reblath>greenArmor strategies.<br>
				- Repetitions, average profit.
			</p>
		</div>
	</body>

</html>







